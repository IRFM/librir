import os
import sys

from setuptools import setup, find_packages


def get_requires(path):
    try:
        res = []
        with open(path, "r") as file:
            # reading each line
            for line in file:
                # reading each word
                for word in line.split():
                    res.append(word)
    except:
        pass
    return res


def get_extra_requires(path, add_all=True):
    """
    https://hanxiao.io/2019/11/07/A-Better-Practice-for-Managing-extras-require-Dependencies-in-Python/

    @param path:
    @param add_all:
    @return:
    """
    from collections import defaultdict

    with open(path) as fp:
        extra_deps = defaultdict(set)
        for k in fp:
            if k.strip() and not k.startswith("#"):
                tags = set()
                if ":" in k:
                    k, v = k.split(":")
                    tags.update(vv.strip() for vv in v.split(","))
                for t in tags:
                    extra_deps[t].add(k)

        # add tag `all` at the end
        if add_all:
            extra_deps["all"] = set(vv for v in extra_deps.values() for vv in v)

    return extra_deps


def package_files(directory):
    print(directory)
    paths = []
    for path, directories, filenames in os.walk(directory):
        for filename in filenames:
            paths.append(os.path.join(".", path, filename))
            paths[-1] = paths[-1].replace("\\", "/")
    return paths


licenses_files = package_files("librir/LICENSES")
libs_files = package_files("librir/libs")
print(licenses_files)


DYNAMIC_LIBRARY_SUFFIX = "dll" if sys.platform == "win32" else "so"

EXCLUDED_PACKAGES = []
PACKAGES = find_packages(exclude=EXCLUDED_PACKAGES)

LIB_GLOBPATH = f"libs/*.{DYNAMIC_LIBRARY_SUFFIX}*"

setup(
    name="librir",
    version="@PROJECT_VERSION_MAJOR@.@PROJECT_VERSION_MINOR@.@PROJECT_VERSION_PATCH@",

    packages=PACKAGES,
    package_data={"librir": [LIB_GLOBPATH]},
    data_files=[
        ("librir-core/LICENSES", licenses_files),
        ("librir-core", ["./librir/LICENSE"]),
    ],
    include_package_data=True,
    install_requires=[
        "numpy",
        "pandas",
        "opencv-python==4.5.5.64",
        "joblib",
        "future-annotations;python_version<'3.7'",
    ]
    + get_requires("requirements.txt"),
    python_requires=">=3.7",
    url="",
    license="BSD-3-clause",
    author="VM213788, LD243615, EG264877",
    author_email="victor.moncada@cea.fr, leo.dubus@cea.fr, erwan.grelier@cea.fr",
    description=(
        "Librir is a C/C++/Python library to manipulate infrared video "
        "and building Cognitive Vision/Machine Learning applications."
    ),
    long_description="""@README_CONTENT@""",
    long_description_content_type="text/markdown",
)
